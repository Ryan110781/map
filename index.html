<!DOCTYPE html>
<html>
<head>
  <title>Leaflet åœ°åœ–æœå°‹ + å°èˆª Demo</title>
  <meta charset="utf-8" />
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <!-- Geocoder CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <!-- Routing Machine CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />

  <style>
    #map {
      height: 90vh;
      width: 100%;
    }
    /* å®šä½æŒ‰éˆ•æ¨£å¼ */
    .locate-button {
      background: white;
      border: 2px solid #666;
      border-radius: 4px;
      cursor: pointer;
      padding: 6px 8px;
      margin: 2px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.3);
    }
    .locate-button:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <h3>è‡ªå·±æ¸²æŸ“çš„åœ°åœ– + åœ°å€æœå°‹ + å°èˆªï¼ˆè‡ªå‹•èµ·é» + é»çµ‚é»ï¼‰</h3>
  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Geocoder JS -->
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <!-- Routing Machine JS -->
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>

  <script>
    let map;
    let marker;
    let routeControl;
    let startPoint = null;
    let endPoint = null;

    // åˆå§‹åŒ–åœ°åœ–
    function initMap(lat, lon) {
      map = L.map('map').setView([lat, lon], 15);

      // OSM åœ–ç£š
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);

      // é è¨­æ¨™è¨˜ï¼ˆè‡ªå‹•ç•¶ä½œå°èˆªèµ·é»ï¼‰
      startPoint = L.latLng(lat, lon);
      marker = L.marker(startPoint).addTo(map)
        .bindPopup("ç›®å‰ä½ç½®ï¼ˆèµ·é»ï¼‰")
        .openPopup();

      // æœå°‹æ§åˆ¶
      L.Control.geocoder({ defaultMarkGeocode: false })
      .on('markgeocode', function(e) {
        const latlng = e.geocode.center;
        map.setView(latlng, 16);

        if (marker) map.removeLayer(marker);
        marker = L.marker(latlng).addTo(map)
          .bindPopup(e.geocode.name)
          .openPopup();
      })
      .addTo(map);

      // ğŸ“å–®æ¬¡å®šä½æŒ‰éˆ•
      const locateControl = L.control({position: 'topleft'});
      locateControl.onAdd = function() {
        const button = L.DomUtil.create('button', 'locate-button');
        button.innerHTML = "ğŸ“";
        button.title = "å›åˆ°ç›®å‰ä½ç½®";
        button.onclick = () => locateUser();
        return button;
      };
      locateControl.addTo(map);

      // ğŸ›£ï¸ é»åœ°åœ–è¨­å®šçµ‚é»ä¸¦å°èˆª
      map.on('click', function(e) {
        if (!endPoint) {
          endPoint = e.latlng;
          L.marker(endPoint).addTo(map).bindPopup("çµ‚é»").openPopup();
          
          // ç•«è·¯ç·š
          routeControl = L.Routing.control({
            waypoints: [startPoint, endPoint],
            routeWhileDragging: true,
            showAlternatives: true
          }).addTo(map);
        } else {
          // é‡ç½®çµ‚é»èˆ‡è·¯ç·š
          if (routeControl) map.removeControl(routeControl);
          map.eachLayer((layer) => {
            if (layer instanceof L.Marker && layer != marker) map.removeLayer(layer);
          });
          endPoint = e.latlng;
          L.marker(endPoint).addTo(map).bindPopup("çµ‚é»").openPopup();

          // é‡æ–°ç•«è·¯ç·š
          routeControl = L.Routing.control({
            waypoints: [startPoint, endPoint],
            routeWhileDragging: true,
            showAlternatives: true
          }).addTo(map);
        }
      });
    }

    // ğŸ“å–®æ¬¡å®šä½
    function locateUser() {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            map.setView([lat, lon], 16);

            if (marker) map.removeLayer(marker);
            startPoint = L.latLng(lat, lon);
            marker = L.marker(startPoint).addTo(map)
              .bindPopup("ç›®å‰ä½ç½®ï¼ˆèµ·é»ï¼‰")
              .openPopup();
          },
          () => alert("ç„¡æ³•å–å¾—ç›®å‰ä½ç½®ï¼")
        );
      } else alert("ä½ çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½");
    }

    // åˆå§‹åŒ–åœ°åœ–
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => initMap(pos.coords.latitude, pos.coords.longitude),
        () => initMap(25.0330, 121.5654) // å°åŒ— 101
      );
    } else {
      initMap(25.0330, 121.5654);
    }
  </script>
</body>
</html>